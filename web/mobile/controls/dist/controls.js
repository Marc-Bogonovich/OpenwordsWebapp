function defineCompOwmlPreview(){Vue.component("comp-owml-preview",{template:"#comp_owml_preview",props:["owml"],methods:{downloadOWML:function(){var blob=new Blob([this.owml],{type:"text/plain;charset=utf-8"});saveAs(blob,"your_lesson.txt")}}})}function defineCompSoundIn(){Vue.component("comp-sound-in",{template:"#comp_sound_in",props:["text","list","myIconSize"],data(){return{recording:false,recordingDone:false}},created(){this.list.push(this);this.audioContext=null;var self=this;this.worker=new Worker("libs/dist/EncoderWorker.js");self.worker.onmessage=function(event){self.blob=event.data.blob;self.recording=false;self.recordingDone=true};this.blob=null;this.input=null;this.processor=null;this.microphone=null;this.localMediaStream=null},methods:{forfeitRecording(){this.recordingDone=false;this.cancelRecording()},cancelRecording(){this.localMediaStream.getTracks().forEach(function(streamTrack){streamTrack.stop()});if(this.audioContext.destination){this.audioContext.destination.disconnect();this.audioContext.close()}if(this.processor){this.processor.disconnect()}this.input.disconnect();this.microphone.disconnect();this.recording=false},startRecording(){this.list.forEach(function(comp){if(comp.audioContext){comp.cancelRecording()}});this.recording=false;this.audioURL=null;var self=this;if(navigator.mediaDevices===undefined){navigator.mediaDevices={};console.log("navigator.mediaDevices not supported")}if(navigator.mediaDevices.getUserMedia){self.audioContext=new AudioContext;if(self.audioContext.createScriptProcessor===null){self.audioContext.createScriptProcessor=self.audioContext.createJavaScriptNode}self.input=self.audioContext.createGain();self.input.gain.value=1;function start(){console.log("recording...");self.recording=true;self.processor=self.audioContext.createScriptProcessor(0,2,2);console.log("default BufferSize: "+self.processor.bufferSize);self.processor.onaudioprocess=function(event){self.worker.postMessage({command:"record",buffers:getChannelBuffers(event)})};self.input.connect(self.processor);self.processor.connect(self.audioContext.destination);self.worker.postMessage({command:"start",sampleRate:self.audioContext.sampleRate,bitRate:128})}navigator.mediaDevices.getUserMedia({audio:true}).then(function(stream){self.microphone=self.audioContext.createMediaStreamSource(stream);self.microphone.connect(self.input);self.localMediaStream=stream;start()}).catch(function(error){console.log(error);self.$f7.alert(null,self.$t("audio-error"))})}else{self.$f7.alert(self.$t("audio-error-message"),self.$t("api-error"))}},playRecording(){var self=this;if(!self.audioURL){self.audioURL=window.URL.createObjectURL(self.blob)}new Howl({src:[self.audioURL],format:["mp3"],onloaderror:function(){self.$f7.alert(null,self.$t("onload-error"))}}).play()},stopRecording(finish){var self=this;self.input.disconnect();self.processor.disconnect();self.worker.postMessage({command:finish?"finish":"cancel"})}},destroyed(){var self=this;this.list.forEach(function(item,index,array){if(item===self){array.splice(index,1);console.log("soundInList: "+array.length)}});if(this.localMediaStream){this.cancelRecording()}this.worker.terminate();console.log("comp_sound-in destroyed")}})}const en={cancel:"Cancel","sound-out":"sound-out (mp3)",play:"Play","forfeit-success":"Course progress deleted","load-sound":"Loading sound...","edit-course":"Edit Course","update-fail":"Update Fail",upload:"Upload","forfeit-course":"Forfeit Course","save-name":"Course must have a name!","logout-OK":"Really logout?","post-on":"Posted on ","type-in":"type-in","see-you":"See you^_^",password:"Password",logout:"Log Out","upload-fail":"Upload fail","sync-course":"Syncing Course",record:"Record","comment-sent":"Comment Sent","registration-fail-message":"The user name or E-mail already exists","your-courses":"Your Courses","use-this-sound":"Use this sound","lesson-preview":"Lesson Preview",audience:"Audience","choose-lesson":"Choose a lesson",edit:"Edit","course-message-2":"Please enter a simple description for the course","comment-txt":"It will be great if you have any comment to this lesson!","delete-lesson":"Deleting Lesson","course-message-1":"Please enter a name for the course",fail:"Fail","your-studys":"Your Studys","record-new-sound":"Record new sound","create-account":"Create Account",stop:"Stop","search-course-tip":"Search by Course Name","delete-course-message":'Are you sure to delete Course "{courseName007D"?',"save-message":"Don't forget to save your intended changes","select-local-audio":"Select local audio","end-feedback-mode":"End Feedback Mode","onload-error":"The file is not playable","lesson-delete":"Lesson deleted","delete-course":"Deleting Course","move-down":"Move down","support-type":"Supported Attachment Types","upload-lesson":"Upload Lesson","save-success":"Save successful",wait:"Please wait...",syncing:"Syncing course...","comment-sent-message":"Please say something",save:"Save",login:"Login","select-txt":"Select a TXT",result:"Result","check-progress":"Checking progress...","forfeit-message":"Are you sure to forfeit this course? Study progress will be discarded.","choose-lesson-message-2":"to upload your lessons.","your-sounds":"Your Sounds in Openwords","choose-lesson-message-1":"You don't have any lesson yet,go to","remove-sound-attachments":"Remove Sound Attachments",courses:"Courses",connect:"Connecting to Openwords...","audio-error":"Audio Error","create-name-error-2":"name is too short(<3)","notice-message":"We have updated our internal data structure so the lessons/courses made before v0.3.0 will not work,please remake (delete and then upload) your lessons/courses when necessary,sorry about the inconvenience!",languages:"Language","upload-success":"Upload success",learn:"Learn","save-fail":"Save failed","sync-fail":"Cannot sync course","create-name-error-1":"name is required","play-sound":"Play sound",progress:"Progress","delete-fail":"Delete fail",register:"Register","move-up":"Move up","create-course":"Create Course","exit-message":"You are now exiting this app, are you sure?",use:"Use","login-fail":"Login fail",language:"English","lesson-result":"Lesson Result","remove-sound":"Remove sound",continue:"(continue)","create-username":"Your user name","manage-lesson":"Manage Your Lessons","upload-lesson-message":"Please enter a name for the lesson","upload-name-error":"You've provided invalid information","delete-lesson-message":'Are you sure to delete Lesson "007BlessonName007D"?',"load-course":"Cannot load course","create-email":"E-mail","continue-study":"Continue Study",sync:"Sync","cannot-play":"Cannot play audio","create-password2-error":"check your password",success:"Success","immediate-feedback-mode":"Immediate Feedback Mode","server-error":"No response from server","manage-course":"Manage Your Courses",preview:"Preview","record-sound":"Record Sound","uploading-lesson":"Uploading Lesson",submit:"Submit","course-content":"Course Content","your-lessons":"Your Lessons",back:"Back","login-fail-message":"The password is incorrect or the user does not exist",error:"Error",delete:"Delete","creating-course":"Creating Course",remove:"Remove","course-delete":"Course deleted","api-error":"Web Audio API not supported","sync-message":"You can sync this course to the newest version that the course author has made.But please note that this will erase the entire progress of this course you made so far,want to continue?","audio-error-message":"Please update your browser to its newest version or change a browser",end:"End","submit-comment":"Submit Comment",ok:"OK","upload-sound-file":"Upload Sound File","remove-sound-message":'Are you sure to remove all sound attachments of this item: "007BitemText007D"?',notice:"Notice","audience-message":"You don't have any audience on your courses yet!","clear-search":"Clear Search",go:"Go",forfeit:"Forfeit",username:"Username or Email","create-email-error-1":"email is required","create-email-error-2":"check your email","create-pass-error-1":"password is required","create-pass-error-2":"password is too short(<6)","search-course":"Search Courses","see-you-message":"Don't forget to add this web app to your phone's home screen!","registration-fail":"Registration fail","add-lesson":"Add Lesson",comment:"Comment","account-created":"Account created","item-text":"Item Text","create-password":"Retype Password","lessson-manage-title":"Manage Lesson","course-manage-title":"Manage Course",more:"More","type-someting":"Please type someting","no-results":"No Results","waiting-language":"Loading Language Translation...",confirm:"Confirm","button-lesson-comments":"Comments from audience","title-comments-list":"Comments","note-last-study":"Last studied",download:"Download","owml-preview":"OWML Preview","add-sound-in":"AddSoundIn","remove-sound-in":"RemoveSoundIn","go-view-format":"OWML"};const supportedLanguages=[{code:"en",name:"English"},{code:"zh-cn",name:"中文（简体）"},{code:"zh-hk",name:"中文（繁體）"},{code:"ja",name:"日本語"}];function defineCourseEditPage(){Vue.component("page-course-edit",{template:"#page_course_edit",data(){return{course:{json:{}},courseContentChanged:false,myLessons:{page:1,pageSize:1e4,list:null},wentToLessonManager:false}},mounted(){var self=this;$.get(ServerAddress+"getCourseLessons",{makeTime:self.$store.state.chosenCourse.makeTime},function(res){if(!res.errorMessage){var copy=JSON.parse(JSON.stringify(self.$store.state.chosenCourse));copy.json.lessons=res.result;self.course=copy}});listLesson(this.myLessons)},methods:{back(){if(this.courseContentChanged){this.$f7.alert(null,this.$t("save-message"));this.courseContentChanged=false;return}this.$router.back()},goToLessonManager(){this.wentToLessonManager=true;this.$router.load({url:"/lessonManager/"})},addLessonFromPool(lesson){this.courseContentChanged=true;if(this.course){this.course.json.lessons.push(JSON.parse(JSON.stringify(lesson)))}},saveCourse(){var self=this;if(!self.course.name){self.$f7.alert(null,self.$t("save-name"));return}self.course.json.totalLesson=self.course.json.lessons.length;self.course.content=JSON.stringify(self.course.json);self.course.json=null;$.ajax(ServerAddress+"saveCourse",{method:"POST",data:{course:JSON.stringify(self.course)}}).done(function(res){if(res.errorMessage){self.$f7.alert(null,self.$t("save-fail"))}else{self.$f7.alert(null,self.$t("save-success"));self.$router.back()}})},courseLessonAction(index){var self=this;var lessonArray=self.course.json.lessons;self.course.json.lessons=lessonArray;self.$f7.actions([{text:self.$t("move-up"),onClick:function(){if(index>0){var les=lessonArray[index];var itemGoDown=lessonArray[index-1];lessonArray.splice(index-1,1,les);lessonArray.splice(index,1,itemGoDown);self.courseContentChanged=true}}},{text:self.$t("move-down"),onClick:function(){if(index<lessonArray.length-1){var les=lessonArray[index];var itemGoUp=lessonArray[index+1];lessonArray.splice(index+1,1,les);lessonArray.splice(index,1,itemGoUp);self.courseContentChanged=true}}},{text:self.$t("immediate-feedback-mode"),onClick:function(){var lesson=lessonArray[index];lesson.imf=true;self.courseContentChanged=true}},{text:self.$t("end-feedback-mode"),onClick:function(){var lesson=lessonArray[index];lesson.imf=false;self.courseContentChanged=true}},{text:self.$t("remove"),color:"red",onClick:function(){lessonArray.splice(index,1);self.courseContentChanged=true}},{text:self.$t("cancel")}])},popupOpened(){if(this.wentToLessonManager){this.wentToLessonManager=false;listLesson(this.myLessons)}}}})}function defineCourseManagerPage(){Vue.component("page-course-manager",{template:"#page_course_manager",data(){return{myCourseList:{page:1,pageSize:1e4,my:true,list:null}}},mounted(){listCourse(this.myCourseList)},methods:{createCourse(){var self=this;self.$f7.prompt(self.$t("course-message-1"),self.$t("creating-course"),function(v){var name=v;self.$f7.prompt(self.$t("course-message-2"),self.$t("creating-course"),function(v){var comment=v;$.get(ServerAddress+"createCourse",{name:name,comment:comment,username:self.$store.state.userInfo.username},function(res){if(!res.errorMessage){self.$f7.alert(null,self.$t("success"));listCourse(self.myCourseList)}else{self.$f7.alert(null,self.$t("fail"))}})})})},courseAction(c,index){var self=this;self.$store.commit("setChosenCourse",c);self.$f7.actions([{text:self.$t("edit"),onClick:function(){self.$router.load({url:"/editCourse/"})}},{text:self.$t("delete"),color:"red",onClick:function(){self.$f7.confirm(self.$t("delete-course-message",{courseName:c.name}),self.$t("delete-course"),function(){$.get(ServerAddress+"deleteCourse",{makeTime:c.makeTime},function(res){if(!res.errorMessage){self.$f7.alert(null,self.$t("course-delete"));self.myCourseList.list.splice(index,1)}})})}},{text:self.$t("cancel")}])}}})}function defineCourseProgressPage(){Vue.component("page-course-progress",{template:"#page_course_progress",computed:{courseData(){return this.$store.state.learningCourse}},data(){return{canSync:false}},created(){this.$store.state.pageInstances.courseProgress=this;var self=this;self.$f7.showPreloader(self.$t("check-progress"));$.get(ServerAddress+"copyCourse",{makeTime:self.courseData.makeTime,authorId:self.courseData.authorId},function(res){self.$f7.hidePreloader();if(res.errorMessage){self.$f7.alert(null,self.$t("load-course"));return}res.result.fileCover=self.$store.state.learningCourse.fileCover;self.$store.commit("setLearningCourse",res.result);self.canSync=res.canSync})},methods:{learnLesson(les){this.$store.commit("setLearningLesson",les);this.$router.load({url:"/steps/"})},syncCourse(){var self=this;var course=self.$store.state.learningCourse;self.$f7.confirm(self.$t("sync-message"),self.$t("syncing"),function(){self.$f7.showPreloader(self.$t("syncing"));$.get(ServerAddress+"syncCourse",{makeTime:course.makeTime,authorId:course.authorId}).then(function(res){self.$f7.hidePreloader();if(res.errorMessage){self.$f7.alert(null,self.$t("sync-fail"));return}course.json=res.result.json;course.updated=res.result.updated;self.canSync=false})})},forfeitCourse(){var self=this;var course=this.$store.state.learningCourse;self.$f7.confirm(self.$t("forfeit-message"),self.$t("forfeit-course"),function(){$.get(ServerAddress+"deleteCourse",{makeTime:course.makeTime,authorId:course.authorId},function(res){if(!res.errorMessage){self.$f7.alert(null,self.$t("forfeit-success"));self.$router.back()}})})}},destroyed(){this.$store.state.pageInstances.courseProgress=null}})}function defineHomePage(){Vue.component("page-home",{template:"#page_home",data(){return{parts:[true,false]}},created(){this.$store.state.pageInstances.home=this},methods:{showPart(i){this.parts.forEach(function(item,index,array){if(i===index){array.splice(index,1,true)}else{array.splice(index,1,false)}})}}})}function defineLessonManagerPage(){Vue.component("page-lesson-manager",{template:"#page_lesson_manager",data(){return{buttonShow:false,name:null,uploadFlag:false,uploadingFile:{name:null},myLesson:{page:1,pageSize:1e4,list:null},comments:null,OWML:null}},created(){this.$store.state.pageInstances.lessonManager=this},mounted(){listLesson(this.myLesson);var self=this;var dropzone=new Dropzone("#my-upload",{url:ServerAddress+"uploadLesson",maxFiles:10,maxFilesize:512,acceptedFiles:".txt",autoProcessQueue:false,previewTemplate:'<div class="dz-preview dz-file-preview"> \n                                   <div class="dz-details"> \n                                       <div class="dz-filename"><span data-dz-name></span></div>\n                                       <div class="dz-size" data-dz-size></div>\n                                   </div>\n                                   <div class="dz-success-mark"></div>\n                                  </div>'});dropzone.on("addedfile",function(file){self.buttonShow=true});dropzone.on("sending",function(file,xhr,formData){formData.append("name",self.name)});dropzone.on("removedfile",function(file,xhr,formData){self.buttonShow=false});dropzone.on("success",function(file){self.uploadFlag=true});dropzone.on("complete",function(file){if(self.uploadFlag){listLesson(self.myLesson);self.$f7.alert(null,self.$t("upload-success"));self.buttonShow=false;self.uploadFlag=false}else{self.$f7.alert(null,self.$t("upload-fail"));Dropzone.forElement("#my-upload").removeFile(file);self.buttonShow=false}})},methods:{showSupport:function(){this.$f7.alert("<div>sound-out (mp3)</div><div>sound-in</div><div>type-in</div>",this.$t("support-type"))},uploadFile:function(){var self=this;self.$f7.prompt(self.$t("upload-lesson-message"),self.$t("uploading-lesson"),function(v){self.name=v;if(self.name){Dropzone.forElement("#my-upload").processQueue()}else{self.$f7.alert(null,self.$t("upload-name-error"))}})},reset:function(){var self=this;Dropzone.forElement("#my-upload").removeAllFiles();self.uploadingFile={name:null}},lessonAction:function(le,index){var self=this;self.myLesson.chosenLesson=le;self.$f7.actions([{text:self.$t("preview"),onClick:function(){self.$store.commit("setLessonPreviewData",{data:JSON.parse(JSON.stringify(le)),index:index});self.$router.load({url:"/lessonPreview/"})}},{text:self.$t("button-lesson-comments"),onClick:function(){self.listComments()}},{text:self.$t("owml-preview"),onClick:function(){self.OWML=jsonToOWML(le.json);self.$f7.popup(".popup-OWML-preview")}},{text:self.$t("delete"),color:"red",onClick:function(){self.$f7.confirm(self.$t("delete-lesson-message",{lessonName:self.myLesson.chosenLesson.name}),self.$t("delete-lesson"),function(){var params={name:self.myLesson.chosenLesson.name};$.get(ServerAddress+"deleteLesson",params,function(res){if(!res.errorMessage){self.myLesson.list.splice(index,1);self.$f7.alert(null,self.$t("lesson-delete"))}})})}},{text:self.$t("cancel")}])},listComments(){var self=this;$.ajax(ServerAddress+"listComment",{data:{authorId:self.myLesson.chosenLesson.userId,lessonName:self.myLesson.chosenLesson.name}}).done(function(res){if(res.errorMessage){self.$f7.alert(null,self.$t("no-results"));return}if(!res.result.length){self.$f7.alert(null,self.$t("no-results"));return}res.result.forEach(function(c){c.json.updated=moment(c.json.updated).format("MMM D, HH:mm")});self.comments=res.result;self.$f7.popup(".popup-comments-list")})}}})}function defineLessonPreview(){Vue.component("page-lesson-preview",{template:"#page_lesson_preview",computed:{lesson(){return this.$store.state.lessonPreview}},data(){return{myParams:{grabCursor:true,spaceBetween:80},mySwiperHandler:null,lessonContentChanged:false}},created(){this.$store.state.pageInstances.lessonPreview=this},mounted(){var swiper=this.Dom7("#my-swiper-container")[0].swiper;this.mySwiperHandler=function(event){if(event.key==="ArrowLeft"){swiper.slidePrev()}else if(event.key==="ArrowRight"){swiper.slideNext()}};this.Dom7(document).keydown(this.mySwiperHandler)},methods:{save(){var self=this;$.ajax(ServerAddress+"updateLessonContent",{method:"POST",data:{name:self.lesson.name,content:JSON.stringify(self.lesson.json)}}).done(function(res){if(res.errorMessage){self.$f7.alert(null,self.$t("update-fail"))}else{self.$f7.alert(null,self.$t("save-success"));self.lessonContentChanged=false;self.$store.state.pageInstances.lessonManager.myLesson.list.splice(self.$store.state.lessonPreviewIndex,1,self.lesson)}})},back(){if(this.lessonContentChanged){this.$f7.alert(null,this.$t("save-message"));this.lessonContentChanged=false;return}this.$router.back()},hasSoundOut(item){var found=false;var uri=null;if(item.attach){item.attach.forEach(function(attach){if(found){return}if(attach.type==="sound-out"){found=true;uri=attach.uri}})}return[found,uri]},hasSoundIn(item){return checkItemAttachmentType(item,"sound-in")},removeSound(item){var self=this;if(item.items){item.items.forEach(function(item){if(item.attach){for(var i=item.attach.length-1;i>=0;i--){if(item.attach[i].type==="sound-out"){item.attach.splice(i,1)}}if(!item.attach.length){delete item.attach}}delete item.hasSoundOut})}else{if(item.attach){for(var i=item.attach.length-1;i>=0;i--){if(item.attach[i].type==="sound-out"){item.attach.splice(i,1)}}if(!item.attach.length){delete item.attach}}delete item.hasSoundOut}self.lessonContentChanged=true},clickItemForSound(item){var self=this;self.$store.commit("setEditItemSound",{item:item});var itemSoundActions=[{text:self.$t("record-new-sound"),onClick:function(){self.$f7.views.main.router.load({url:"/soundManager/"})}},{text:self.$t("play-sound"),soundUri:"hi",onClick:function(){self.$f7.showPreloader(self.$t("load-sound"));var sound=new Howl({src:[this.soundUri],format:["mp3"],onloaderror:function(){self.$f7.hidePreloader();self.$f7.alert(null,self.$t("cannot-play"))},onload:function(){self.$f7.hidePreloader()}});sound.play()}},{text:self.$t("cancel")},{text:self.$t("remove-sound"),color:"red",onClick:function(){self.$f7.confirm(self.$t("remove-sound-message",{itemText:item.text}),self.$t("remove-sound-attachments"),function(){self.removeSound(item);self.$forceUpdate()})}},{text:self.$t("remove-sound-in"),color:"red",onClick:function(){if(item.attach){for(var i=item.attach.length-1;i>=0;i--){if(item.attach[i].type==="sound-in"){item.attach.splice(i,1)}}if(!item.attach.length){delete item.attach}}self.lessonContentChanged=true;self.$forceUpdate()}},{text:self.$t("add-sound-in"),onClick:function(){if(!item.attach){item.attach=[{type:"sound-in"}]}else{item.attach.push({type:"sound-in"})}self.lessonContentChanged=true;self.$forceUpdate()}}];var thisActions=[];var hasSound=false,hasSoundIn=false;if(item.attach){item.attach.forEach(function(attach){if(hasSound){return}if(attach.type==="sound-out"){if(attach.uri){var uri=new URI(attach.uri);var nuri;if(uri.protocol()==="http"||uri.protocol()==="https"){nuri=uri.toString();itemSoundActions[1].soundUri=nuri;hasSound=true;self.$store.state.editItemSound.soundValid=true}else if(uri.protocol()==="openwords"){var segs=uri.segment();nuri="getSound?userId="+segs[0]+"&fileName="+segs[1];nuri=ServerAddress+nuri;itemSoundActions[1].soundUri=nuri;hasSound=true;self.$store.state.editItemSound.soundValid=true;self.$store.state.editItemSound.soundFile=segs[1]}}}if(attach.type==="sound-in"){hasSoundIn=true}})}if(!hasSoundIn){thisActions.push(itemSoundActions[0])}if(hasSound){thisActions.push(itemSoundActions[1]);thisActions.push(itemSoundActions[3])}else{if(hasSoundIn){thisActions.push(itemSoundActions[4])}else{thisActions.push(itemSoundActions[5])}}thisActions.push(itemSoundActions[2]);self.$f7.actions(thisActions)}},beforeDestroy(){console.log("page-lesson_preview beforeDestroy");this.Dom7(document).off("keydown",this.mySwiperHandler);Howler.unload()},destroyed(){console.log("page-lesson_preview destroyed");this.$store.state.pageInstances.lessonPreview=null}})}function defineLoginPage(){Vue.component("page-login",{template:"#page_login",data(){return{username:"",password:""}},created(){var self=this;var lang,langs;if(navigator.languages&&navigator.languages.length){langs=navigator.languages}else if(navigator.userLanguage){lang=navigator.userLanguage}else{lang=navigator.language}console.log(langs);if(!langs.length){langs=[lang]}var found=false;langs.forEach(function(code){if(found){return}supportedLanguages.forEach(function(support){if(found){return}if(code.toLowerCase()===support.code){found=true;if(support.code==="en"){return}self.$store.commit("setCurrentLanguage",support);$.getJSON("static_data/translations/"+support.code+".json").done(function(res){self.$i18n.add(support.code,res);self.$i18n.set(support.code);self.$f7.params.modalButtonCancel=self.$t("cancel");self.$f7.params.modalButtonOk=self.$t("ok")});moment.locale(support.code)}})})},computed:{currentLanguage(){return this.$store.state.currentLanguage},languages(){return supportedLanguages}},methods:{languageChange(language){var self=this;self.$store.commit("setCurrentLanguage",language);if(language.code==="en"){self.$i18n.set("en");self.$f7.params.modalButtonCancel=self.$t("cancel");self.$f7.params.modalButtonOk=self.$t("ok")}else if(self.$i18n.localeExists(language.code)){self.$i18n.set(language.code);self.$f7.params.modalButtonCancel=self.$t("cancel");self.$f7.params.modalButtonOk=self.$t("ok")}else{self.$f7.showPreloader(self.$t("waiting-language"));$.getJSON("static_data/translations/"+language.code+".json").done(function(res){self.$i18n.add(language.code,res);self.$i18n.set(language.code);self.$f7.params.modalButtonCancel=self.$t("cancel");self.$f7.params.modalButtonOk=self.$t("ok");self.$f7.hidePreloader()}).fail(function(){self.$f7.hidePreloader();self.$f7.alert(null,"No language data")})}moment.locale(language.code)},doLogin(){hideVirtualKeyboard();var self=this;console.log("this.$router: "+this.$router);self.$f7.showPreloader(self.$t("connect"));var params={username:this.username,password:this.password};self.$store.commit("setUserInfo",{username:this.username});var loginTime=setTimeout(function(){self.$f7.hidePreloader();self.$f7.alert(self.$t("server-error"),self.$t("error"))},1e4);$.get(ServerAddress+"loginUser",params,function(res){clearTimeout(loginTime);self.$f7.hidePreloader();if(!res.errorMessage){self.$f7.views.main.router.load({url:"/home/"});self.$f7.alert(self.$t("notice-message"),self.$t("notice"))}else{self.$f7.alert(self.$t("login-fail-message"),self.$t("login-fail"))}})},doRegister(){this.$f7.views.main.router.load({url:"/register/"})}},destroyed(){console.log("page-login destroyed")}})}function defineRegisterPage(){var required=window.validators.required;var minLength=window.validators.minLength;var sameAs=window.validators.sameAs;var email=window.validators.email;const touchMap=new WeakMap;Vue.component("page-register",{template:"#page_register",data(){return{myform:{},model:{regUsername:"",regPass:"",regRepass:"",regEmail:""}}},validations:{model:{regUsername:{required:required,minLength:minLength(3)},regPass:{required:required,minLength:minLength(6)},regRepass:{sameAsPassword:sameAs("regPass")},regEmail:{required:required,email:email}},validationGroup:["model.regUsername","model.regPass","model.regRepass","model.regEmail"]},methods:{myInput:function($v){$v.$reset();if(touchMap.has($v)){clearTimeout(touchMap.get($v))}touchMap.set($v,setTimeout($v.$touch,500))},submitOk:function(){var self=this;var regOk=false;self.$f7.showPreloader(self.$t("wait"));setTimeout(function(){self.$f7.hidePreloader();if(!regOk){self.$f7.alert(self.$t("server-error"),self.$t("error"))}},15e3);var params={username:this.model.regUsername,password:this.model.regPass,email:this.model.regEmail};$.get(ServerAddress+"addUser",params,function(res){regOk=true;self.$f7.hidePreloader();if(!res.errorMessage){self.$f7.alert(null,self.$t("account-created"));self.$router.back()}else{self.$f7.alert(self.$t("registration-fail-message"),self.$t("registration-fail"))}})}}})}function defineSoundManagerPage(){Vue.component("page-sound-manager",{template:"#page_sound_manager",computed:{itemSound(){return this.$store.state.editItemSound},lesson(){return this.$store.state.lessonPreview}},data(){return{recording:false,canUpload:false,ok:false,addFile:false,soundList:null,uploadSound:null,soundFileName:null}},created(){this.audioContext=null;this.audioCtx=null;this.worker=null;this.blob=null;this.input=null;this.processor=null;this.microphone=null;this.localMediaStream=null},mounted(){var self=this;$.ajax({url:ServerAddress+"listSound"}).done(function(res){if(res.errorMessage){self.$f7.alert(res.errorMessage,self.$t("error"));return}self.soundList=res.result;self.soundList.forEach(function(item){item.dateString=moment(item.updated).format("MMM D, HH:mm");if(self.$store.state.editItemSound.soundValid&&item.file===self.$store.state.editItemSound.soundFile){item.use=true}})});this.recording=false;var self=this;function visualize(stream){self.audioCtx=new(window.AudioContext||webkitAudioContext);var canvas=document.getElementById("visualizer");var canvasCtx=canvas.getContext("2d");var source=self.audioCtx.createMediaStreamSource(stream);var analyser=self.audioCtx.createAnalyser();analyser.fftSize=2048;var bufferLength=analyser.frequencyBinCount;var dataArray=new Uint8Array(bufferLength);source.connect(analyser);var WIDTH=canvas.width;var HEIGHT=canvas.height;draw();function draw(){requestAnimationFrame(draw);analyser.getByteTimeDomainData(dataArray);canvasCtx.fillStyle="rgb(200, 200, 200)";canvasCtx.fillRect(0,0,WIDTH,HEIGHT);canvasCtx.lineWidth=2;canvasCtx.strokeStyle="rgb(0, 0, 0)";canvasCtx.beginPath();var sliceWidth=WIDTH*1/bufferLength;var x=0;for(var i=0;i<bufferLength;i++){var v=dataArray[i]/128;var y=v*HEIGHT/2;if(i===0){canvasCtx.moveTo(x,y)}else{canvasCtx.lineTo(x,y)}x+=sliceWidth}canvasCtx.lineTo(canvas.width,canvas.height/2);canvasCtx.stroke()}}if(navigator.mediaDevices===undefined){navigator.mediaDevices={};console.log("navigator.mediaDevices not supported")}if(navigator.mediaDevices.getUserMedia){self.audioContext=new AudioContext;if(self.audioContext.createScriptProcessor===null){self.audioContext.createScriptProcessor=self.audioContext.createJavaScriptNode}self.defaultBufferSize=self.audioContext.createScriptProcessor(undefined,2,2).bufferSize;console.log("defaultBufferSize: "+self.defaultBufferSize);self.input=self.audioContext.createGain();self.input.gain.value=1;self.worker=new Worker("libs/dist/EncoderWorker.js");self.worker.onmessage=function(event){self.blob=event.data.blob;var node=document.getElementById("sound_controls");var audioURL=window.URL.createObjectURL(self.blob);var audio=document.createElement("audio");audio.setAttribute("controls","");audio.setAttribute("style","width: 100%;");audio.src=audioURL;node.appendChild(audio);self.canUpload=true};navigator.mediaDevices.getUserMedia({audio:true}).then(function(stream){self.microphone=self.audioContext.createMediaStreamSource(stream);self.microphone.connect(self.input);visualize(stream);self.localMediaStream=stream;self.ok=true;self.recording=false;self.canUpload=false}).catch(function(error){console.log(error);self.$f7.alert(null,self.$t("audio-error"))})}else{self.$f7.alert(self.$t("audio-error-message"),self.$t("api-error"))}var dropzone=self.dropzone=new Dropzone("#sound-upload",{url:ServerAddress+"uploadSound",params:{text:self.itemSound.item.text,type:"mp3"},maxFiles:1,autoProcessQueue:false,acceptedFiles:".mp3"});dropzone.on("addedfile",function(file){if(file.name){self.soundFileName=file.name;var audioURL=window.URL.createObjectURL(file);self.uploadSound=new Howl({src:[audioURL],format:["mp3"],onloaderror:function(){self.addFile=false;self.$f7.alert(null,self.$t("onload-error"))},onload:function(){self.addFile=true}})}else{file.name="test.mp3"}});dropzone.on("success",function(file,xhr){this.removeAllFiles();self.addFile=false;var fileName=xhr.trim();console.log(fileName);self.updateLessonContentForItemSound(fileName);$.ajax({url:ServerAddress+"listSound"}).done(function(res){if(res.errorMessage){self.$f7.alert(res.errorMessage,self.$t("error"));return}res.result[0].use=true;self.soundList=res.result;self.soundList.forEach(function(item){if(!item.use){item.dateString=moment(item.updated).format("MMM D, HH:mm")}});self.$f7.alert(null,self.$t("upload-success"))})})},methods:{playFile(){this.uploadSound.play()},cancelFile(){this.dropzone.removeAllFiles();this.uploadSound.stop();this.addFile=false},pickSound(soundItem,index){var self=this;self.$f7.actions([{text:self.$t("play"),onClick:function(){var sound=new Howl({src:[ServerAddress+"getSound?userId="+soundItem.userId+"&fileName="+soundItem.file],format:["mp3"],onloaderror:function(){self.$f7.alert(null,self.$t("cannot-play"))}});sound.play()}},{text:self.$t("use-this-sound"),onClick:function(){self.soundList.forEach(function(item){if(item===soundItem){item.use=true;self.updateLessonContentForItemSound(item.userId+"/"+item.file)}else{delete item.use;item.dateString=moment(item.updated).format("MMM D, HH:mm")}});self.$forceUpdate()}},{text:self.$t("delete"),color:"red",onClick:function(){var params={time:soundItem.updated};$.get(ServerAddress+"deleteSound",params,function(res){if(!res.errorMessage){self.soundList.splice(index,1)}else{self.$f7.alert(null,self.$t("delete-fail"))}})}},{text:self.$t("cancel")}])},updateLessonContentForItemSound:function(newSoundFileName){var self=this;if(!self.itemSound.item.attach){self.itemSound.item.attach=[{type:"sound-out"}]}var found=false;self.itemSound.item.attach.forEach(function(attach){if(found){return}if(attach.type==="sound-out"){attach.uri="openwords://user/"+newSoundFileName;found=true}});if(!found){self.itemSound.item.attach.push({type:"sound-out",uri:"openwords://user/"+newSoundFileName})}self.$store.state.pageInstances.lessonPreview.lessonContentChanged=true},clearSoundDemo(){var node=document.getElementById("sound_controls");while(node.hasChildNodes()){node.removeChild(node.lastChild)}},startRecording(){this.clearSoundDemo();this.recording=true;this.canUpload=false;var self=this;self.processor=self.audioContext.createScriptProcessor(self.defaultBufferSize,2,2);self.processor.onaudioprocess=function(event){self.worker.postMessage({command:"record",buffers:getChannelBuffers(event)})};self.input.connect(self.processor);self.processor.connect(self.audioContext.destination);self.worker.postMessage({command:"start",sampleRate:self.audioContext.sampleRate,bitRate:128})},stopRecording(finish){var self=this;self.input.disconnect();self.processor.disconnect();self.worker.postMessage({command:finish?"finish":"cancel"});self.recording=false},uploadSoundFile(){this.dropzone.processQueue()},uploadRecording(){this.dropzone.removeAllFiles();this.dropzone.addFile(this.blob);this.dropzone.processQueue();this.canUpload=false}},beforeDestroy(){console.log("page-sound-manager beforeDestroy");this.localMediaStream.getTracks().forEach(function(streamTrack){streamTrack.stop()});this.audioContext.destination.disconnect();if(this.processor){this.processor.disconnect()}this.input.disconnect();this.microphone.disconnect();this.audioCtx.close();this.audioContext.close();if(this.$store.state.pageInstances.lessonPreview){this.$store.state.pageInstances.lessonPreview.$forceUpdate()}},destroyed(){console.log("page-sound-manager destroyed")}})}function defineStepsPage(){Vue.component("page-steps",{template:"#page_steps",computed:{lesson(){return this.$store.state.learningLesson}},data(){return{myParams:{grabCursor:true,spaceBetween:80},mySwiperHandler:null,reachFinal:false,answerPool:[],lessonComment:{text:"",done:false},canGoResult:false,onPlay:false,onPause:false,onReady:false,rate:1,secondsDisplay:"0s",soundInList:[],owmlText:null}},created(){var self=this;this.lesson.json.steps.forEach(function(step,index){step.id=index+1;var noAnswer=true;var answeredText=[];if(!self.answerPool[index]){self.answerPool[index]=[]}step.lines.forEach(function(line){line.forEach(function(item){gatherSoundOut(item);if(item.type==="ans"){noAnswer=false;if(checkItemAttachmentType(item,"type-in")){item.hasTypeIn=true;if(!item.userInput){item.userInput={text:""}}if(item.items){item.items.forEach(function(item){var copy=JSON.parse(JSON.stringify(item));copy.typein=true;self.answerPool[index].push(copy)})}else{var copy=JSON.parse(JSON.stringify(item));copy.typein=true;self.answerPool[index].push(copy)}return}var answered=null;if(item.userInput){answered=item.userInput;answeredText.push(answered.text)}if(item.items){item.items.forEach(function(item){if(answered){if(answered.text===item.text){answered.hasSoundOut=item.hasSoundOut;return}}var copy=JSON.parse(JSON.stringify(item));copy.firedOnce=false;self.answerPool[index].push(copy)})}else{if(answered){if(answered.text===item.text){answered.hasSoundOut=item.hasSoundOut;return}}var copy=JSON.parse(JSON.stringify(item));copy.firedOnce=false;self.answerPool[index].push(copy)}}else if(item.type==="pro"){if(checkItemAttachmentType(item,"sound-in")){item.hasSoundIn=true}}})});if(noAnswer){step.check=true}step.marplots.forEach(function(item){gatherSoundOut(item);for(var i=0;i<answeredText.length;i++){if(answeredText[i]===item.text){return}}var copy=JSON.parse(JSON.stringify(item));copy.firedOnce=false;self.answerPool[index].push(copy)});self.answerPool[index]=_.shuffle(self.answerPool[index])});self.soundTimer=null;self.soundSeconds=0;self.startTimer=function(){if(self.soundTimer){console.log("cannot start timer");return}self.soundTimer=setInterval(function(){if(!self.onPlay){return}self.soundSeconds+=1;self.secondsDisplay=self.soundSeconds+"s"},1e3);console.log("timer started")};self.stopTimer=function(){if(self.soundTimer){clearInterval(self.soundTimer)}self.soundTimer=null;self.soundSeconds=0;self.secondsDisplay="0s";console.log("timer stopped")}},mounted(){var self=this;var swiper=this.Dom7("#my-swiper-container")[0].swiper;swiper.on("onReachEnd",function(swiper){console.log("onReachEnd");self.reachFinal=true;var course=self.$store.state.learningCourse;course.json.learnTime=(new Date).getTime();var totalRight=0;course.json.lessons.forEach(function(les){if(les.ok){totalRight+=1}});course.json.totalLessonRight=totalRight;course.json.totalLesson=course.json.lessons.length;var courseCopy=JSON.parse(JSON.stringify(course));courseCopy.json.lessons.forEach(function(lesson){lesson.json.steps.forEach(function(step){delete step.id;step.lines.forEach(function(line){line.forEach(function(item){delete item.hasSoundOut;delete item.soundUris;delete item.hasTypeIn;delete item.hasSoundIn;if(item.userInput){delete item.userInput.hasSoundOut;delete item.userInput.soundUris}})});step.marplots.forEach(function(item){delete item.hasSoundOut;delete item.soundUris})})});courseCopy.content=JSON.stringify(courseCopy.json);courseCopy.json=null;$.ajax(ServerAddress+"saveCourseProgress",{method:"POST",data:{course:JSON.stringify(courseCopy)}}).then(function(res){if(res.errorMessage){self.$f7.alert(null,res.data.errorMessage)}})});this.mySwiperHandler=function(event){if(event.target.nodeName==="SPAN"){return}if(event.key==="ArrowLeft"){swiper.slidePrev()}else if(event.key==="ArrowRight"){swiper.slideNext()}};this.Dom7(document).keydown(this.mySwiperHandler)},methods:{clickItemForSound(item){var self=this;if(item.hasSoundOut){item.soundUris.forEach(function(uri){self.playSound(uri)})}},playSound(myUri){var self=this;var uri=new URI(myUri);var nuri;if(uri.protocol()==="http"||uri.protocol()==="https"){nuri=uri.toString()}else if(uri.protocol()==="openwords"){var segs=uri.segment();nuri="getSound?userId="+segs[0]+"&fileName="+segs[1];nuri=ServerAddress+nuri}if(self.soundPlaying){self.soundPlaying.stop()}self.$f7.showPreloader(self.$t("load-sound"));Howler.autoSuspend=false;test=self.soundPlaying=new Howl({src:[nuri],format:["mp3"],onloaderror:function(){self.$f7.hidePreloader();self.$f7.alert(null,self.$t("cannot-play"));self.onReady=false},onload:function(){console.log("onload");self.$f7.hidePreloader();self.rate=1},onplay:function(){console.log("onplay");self.onPlay=true;self.onPause=false;if(this.duration()<=5){self.onReady=false}else{self.onReady=true;self.startTimer()}},onpause:function(){self.onPlay=false;self.onPause=true},onstop:function(){console.log("onstop");self.onReady=false;self.onPlay=false;self.onPause=false;self.stopTimer()},onend:function(){console.log("onend");self.onReady=false;self.onPlay=false;self.onPause=false;self.stopTimer()}});self.soundPlaying.play()},backSeek(){this.soundSeconds-=5;if(this.soundSeconds<=0){this.soundSeconds=0}this.soundPlaying.seek(this.soundSeconds)},forwardSeek(){this.soundSeconds+=5;this.soundPlaying.seek(this.soundSeconds)},soundRate(){if(this.soundPlaying&&this.onReady){if(this.rate>=1.5){this.rate=.4}this.rate+=.1;this.rate=parseFloat(this.rate.toFixed(1));this.soundPlaying.rate(this.rate)}},pauseSound(){if(this.onReady&&this.onPlay){this.soundPlaying.pause()}},resumeSound(){if(this.onReady&&this.onPause){this.soundPlaying.play()}},typeInDone(index){this.typeinItemIndex=index;this.de()},de:_.debounce(function(){var self=this;console.log("check");var allOk=true;var step=self.lesson.json.steps[this.typeinItemIndex];step.lines.forEach(function(line){line.forEach(function(item){if(item.type==="ans"){if(item.userInput){item.ok=self.checkAnswerText(item,item.userInput.text)}else{item.ok=false}if(!item.ok){allOk=false}}})});step.check=allOk;self.lesson.ok=checkLesson(self.lesson.json.steps);self.$forceUpdate()},700),checkAnswerText(item,incomingText){var i;if(item.items){for(i=0;i<item.items.length;i++){if(item.items[i].text===incomingText){return true}}}else if(item.text){if(item.text===incomingText){return true}else{return false}}return false},removeAnswerFromPool(a,stepIndex){var pool=this.answerPool[stepIndex];for(var i=0;i<pool.length;i++){if(pool[i]===a){pool.splice(i,1);return}}},pickAnswer(a,stepIndex){console.log("pickAnswer");var self=this;if(a.hasSoundOut){if(!a.firedOnce&&a.soundUris.length){a.firedOnce=true;a.soundUris.forEach(function(uri){self.playSound(uri)});if(a.firedOnce){return}}}var foundOne=false;var allOk=true;var step=self.lesson.json.steps[stepIndex];step.lines.forEach(function(line){line.forEach(function(item){if(item.type==="ans"){if(!item.userInput&&!foundOne){foundOne=true;delete a.firedOnce;delete a.ok;item.userInput=a;self.removeAnswerFromPool(a,stepIndex)}if(item.userInput){item.ok=self.checkAnswerText(item,item.userInput.text)}else{item.ok=false}if(!item.ok){allOk=false}}})});step.check=allOk;self.lesson.ok=checkLesson(self.lesson.json.steps);self.$forceUpdate()},removeInput(item,stepIndex){if(item.userInput){item.userInput.firedOnce=false}this.answerPool[stepIndex].push(item.userInput);item.userInput=null;this.lesson.json.steps[stepIndex].check=false;this.lesson.ok=false;this.$forceUpdate()},slideTo(index){var swiper=this.Dom7("#my-swiper-container")[0].swiper;swiper.slideTo(index)},goFinal(){var swiper=this.Dom7("#my-swiper-container")[0].swiper;swiper.slideTo(this.lesson.json.steps.length)},sendComment(){var self=this;if(!self.lessonComment.text){self.$f7.alert(null,self.$t("comment-sent-message"));return}self.lessonComment.done=true;var pack={content:{comment:self.lessonComment.text,name:self.lesson.name,userId:self.lesson.userId,updated:self.lesson.updated}};pack.content=JSON.stringify(pack.content);$.ajax(ServerAddress+"postComment",{method:"POST",data:{comment:JSON.stringify(pack)}}).then(function(res){if(res.errorMessage){self.$f7.alert(null,res.errorMessage)}else{self.$f7.alert(null,self.$t("comment-sent"))}})},previewOWML(){this.owmlText=jsonToOWML(this.lesson.json);this.$f7.popup(".popup-OWML-preview")}},beforeDestroy(){this.Dom7(document).off("keydown",this.mySwiperHandler);if(this.$store.state.pageInstances.courseProgress){this.$store.state.pageInstances.courseProgress.$forceUpdate()}Howler.unload()},destroyed(){console.log("page-steps destroyed")}})}function defineCourseStudy(){Vue.component("page-study",{template:"#page_study",data(){return{myStudyList:{page:1,pageSize:1e4,user:true,list:null}}},mounted(){listCourse(this.myStudyList,null,function(list){list.forEach(function(c){if(c.json.totalLesson&&c.json.totalLessonRight){c.json.progress=(c.json.totalLessonRight/c.json.totalLesson*100).toFixed(0)}})})},methods:{courseAction(c,index){var self=this;self.$f7.actions([{text:self.$t("continue-study"),onClick:function(){self.$store.commit("setLearningCourse",c);self.$router.load({url:"/courseProgress/"})}},{text:self.$t("forfeit"),color:"red",onClick:function(){self.$f7.confirm(self.$t("forfeit-message"),self.$t("forfeit-course"),function(){$.get(ServerAddress+"deleteCourse",{makeTime:c.makeTime,authorId:c.authorId},function(res){if(!res.errorMessage){self.$f7.alert(null,self.$t("forfeit-success"));self.myStudyList.list.splice(index,1)}})})}},{text:self.$t("cancel")}])}}})}function defineAudiencePart(){Vue.component("part-audience",{template:"#part_audience",data(){return{stats:[]}},mounted(){this.$store.state.allCourseList.page=1;var self=this;$.ajax(ServerAddress+"listStats",{data:{type:"c"}}).done(function(res){if(!res.errorMessage){res.result.forEach(function(item){item.lastStudy=moment(item.updated).format("LL");if(item.json.totalLearner&&item.json.finshed){item.per=(item.json.finshed/item.json.totalLearner*100).toFixed(0)}else{item.per=0}});self.stats=res.result}})}})}function defineCourseListPart(){Vue.component("part-course-list",{template:"#part_course_list",computed:{allCourseList(){return this.$store.state.allCourseList}},methods:{showMore(){var self=this;self.allCourseList.page+=1;listCourse(self.allCourseList,null,function(list){self.allCourseList.showCourse.push(...list)})},learnCourse(c){this.$store.commit("setLearningCourse",c);this.$router.load({url:"/courseProgress/"})},clearSearch(){var self=this;delete self.allCourseList.courseNameSearch;self.allCourseList.page=1;listCourse(self.allCourseList,null,function(list){self.allCourseList.showCourse=list})}},mounted(){var self=this;console.log("part-course-list mounted");listCourse(self.allCourseList,null,function(list){self.allCourseList.showCourse=list;$.get(ServerAddress+"getMyProgress",{recent:true},function(res){if(res.result.length!==0){res.result[0].dateString=moment(res.result[0].makeTime).format("LL");res.result[0].displayName=res.result[0].name.toUpperCase();list.unshift(res.result[0]);var i=Math.floor(Math.random()*9)+1;list[0].fileCover="img/test"+i+".jpg";list[0].json.recent=true}})})},updated(){console.log("part-course-list updated");var self=this;if(self.lazy){self.lazy.destroy();$(".page-content").off()}self.lazy=$(".my-lazy").Lazy({effect:"fadeIn",effectTime:1e3,threshold:200,chainable:false});$(".page-content").scroll(function(){self.lazy.update(200)})}})}function listCourse(pack,error,done){pack.canLookAfter=false;$.ajax({url:ServerAddress+"listCourse",data:{pageNumber:pack.page,pageSize:pack.pageSize,authorId:pack.authorId,my:pack.my,user:pack.user,all:pack.all,courseNameSearch:pack.courseNameSearch}}).done(function(res){if(res.errorMessage){if(error){error(res.errorMessage)}return}if(res.result.length===0){pack.list=null;if(error){error("no-results")}return}if(res.result.length>pack.pageSize){pack.canLookAfter=true;res.result.pop()}pack.list=res.result;pack.list.forEach(function(c){var i=Math.floor(Math.random()*9)+1;c.fileCover="img/test"+i+".jpg";c.dateString=moment(c.makeTime).format("LL");c.displayName=c.name.toUpperCase();if(pack.courseNameSearch){var searchTerm=pack.courseNameSearch.toUpperCase();c.displayName=c.displayName.replace(searchTerm,"<span class='course-name-highlight'>"+searchTerm+"</span>")}});if(done){done(pack.list)}})}function listLesson(pack,error){pack.canLookAfter=false;$.ajax({url:ServerAddress+"listLesson",data:{pageNumber:pack.page,pageSize:pack.pageSize}}).done(function(res){if(res.errorMessage){if(error){error(res.errorMessage)}return}if(res.result.length===0){pack.list=null;return}if(res.result.length>pack.pageSize){pack.canLookAfter=true;res.result.pop()}pack.list=res.result})}function checkItemAttachmentType(item,type){var found=false;if(item.items){item.items.forEach(function(item){if(found){return}if(item.attach){item.attach.forEach(function(attach){if(found){return}if(attach.type===type){found=true}})}})}else{if(item.attach){item.attach.forEach(function(attach){if(found){return}if(attach.type===type){found=true}})}}return found}function gatherSoundOut(item){var found=false;var uri=[];if(item.items){item.items.forEach(function(item){if(item.attach){item.attach.forEach(function(attach){if(attach.type==="sound-out"){found=true;if(attach.uri){uri.push(attach.uri)}}})}})}else{if(item.attach){item.attach.forEach(function(attach){if(attach.type==="sound-out"){found=true;if(attach.uri){uri.push(attach.uri)}}})}}if(found){item.hasSoundOut=true;item.soundUris=uri}}function checkLesson(steps){for(var i=0;i<steps.length;i++){if(!steps[i].check){return false}}return true}function screenChange(){var cw=document.documentElement.clientWidth,width=0,sw=window.screen.width,sh=window.screen.height;width=sw<sh?sw:sh;if(cw<=width){$("body").removeClass("screen")}if(cw>width){$("body").addClass("screen")}}function getChannelBuffers(event){var buffers=[];for(var ch=0;ch<2;ch++){buffers[ch]=event.inputBuffer.getChannelData(ch)}return buffers}function jsonToOWML(json){var out="",outAns="";json.steps.forEach(function(step){out+="="+"fb"+"\r\n";step.lines.forEach(function(line){out+="*";line.forEach(function(item){if(item.items){out+="[]";outAns+="#";item.items.forEach(function(item){outAns+="["+item.text+"]";if(item.attach){item.attach.forEach(function(attach){if(attach.type==="type-in"){outAns+="(type-in)"}if(attach.type==="sound-out"){if(attach.uri){outAns+="(sound-out:"+attach.uri+")"}else{outAns+="(sound-out)"}}})}});outAns+="\r\n"}else{if(item.type==="pro"){out+="["+item.text+"]";if(item.attach){item.attach.forEach(function(attach){if(attach.type==="type-in"){out+="(type-in)"}if(attach.type==="sound-out"){if(attach.uri){out+="(sound-out:"+attach.uri+")"}else{out+="(sound-out)"}}if(attach.type==="sound-in"){out+="(sound-in)"}})}}if(item.type==="ans"){out+="[]";outAns+="#["+item.text+"]";if(item.attach){item.attach.forEach(function(attach){if(attach.type==="type-in"){outAns+="(type-in)"}if(attach.type==="sound-out"){if(attach.uri){outAns+="(sound-out:"+attach.uri+")"}else{outAns+="(sound-out)"}}if(attach.type==="sound-in"){outAns+="(sound-in)"}})}outAns+="\r\n"}}});out+="\r\n"});outAns;out+=outAns;outAns="";if(step.marplots.length){out+="%"}step.marplots.forEach(function(item){if(item.items){item.items.forEach(function(item){if(item.type==="mar"){out+="["+item.text+"]"}if(item.attach){item.attach.forEach(function(attach){if(attach.type==="sound-out"){if(attach.uri){out+="(sound-out:"+attach.uri+")"}else{out+="(sound-out)"}}})}})}else{if(item.type==="mar"){out+="["+item.text+"]"}if(item.attach){item.attach.forEach(function(attach){if(attach.type==="sound-out"){if(attach.uri){out+="(sound-out:"+attach.uri+")"}else{out+="(sound-out)"}}})}}});out+="\r\n\r\n\r\n"});return out}function hideVirtualKeyboard(){if(document.activeElement&&document.activeElement.blur&&typeof document.activeElement.blur==="function"){document.activeElement.blur()}}